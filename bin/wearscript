#!/usr/bin/env python2

import argparse
import sys
from wearscript.socket import websocket_client_factory,websocket_server 

def callback(ws, **kw):
    if kw['card']:
        ws.send(
            'startScript',
            """
            <script>
              WS.wake();
              WS.activityCreate();
              WS.displayCardScroll();
              WS.cardInsert(0, WS.cardFactory('%s', 'WearScript'));
            </script>
            """ % (kw['card'])
        )
    if kw['say']:
        if kw['say'] == '-':
            kw['say'] = sys.stdin.read()
        ws.send('startScript',"<script>WS.say('%s')</script>" % kw['say'])
    if (kw['start'] or kw['save']):
        script_name = kw['start'] or kw['save']
        with open (script_name, "r") as script:
            script_data=script.read()
        if kw['start']:
            ws.send('startScript',script_data)
        if kw['save']:
            ws.send('saveScript',script_data,kw['save'].split('.')[0])

parser = argparse.ArgumentParser()
parser.add_argument('--say')
parser.add_argument('--card')
parser.add_argument('--start')
parser.add_argument('--save')
parser.add_argument('--server',metavar="PORT",type=int)
parser.add_argument('--client_endpoint')

args = parser.parse_args()
vargs = dict(vars(args))
if args.server:
    websocket_server(callback,args.server,**vargs)
else:
    websocket_client_factory(callback,**vargs)
